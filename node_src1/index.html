<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>LevelDB Chart</title>
		<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	</head>
	<body>
		<div class="container">
			<div style="margin-top: 30px;">
				<select class="form-control" id="uuids" value="basic" style="width: 200px; float: left;">
				</select>
				<select class="form-control" id="db" value="basic" style="width: 200px; float: left; margin-left: 20px;">
					<option value="basic">Basic</option>
					<option value="30m">30M</option>
					<option value="1h">1H</option>
					<option value="7h">7H</option>
					<option value="1d">1D</option>
					<option value="7d">7D</option>
					<option value="30d">30D</option>
				</select>

				<select class="form-control" id="support" style="width: 200px; float: left; margin-left: 20px;">
					<option value=""></option>
					<option value="total_connection">total_connection</option>
					<option value="avg_connection">avg_connection</option>
				</select>

				<button class="btn btn-success" id="getMore" style="margin-left: 20px;">Submit</button>
			</div>
			<div style="margin-top: 30px;">
				<span><strong>Start time</strong><span id="start-time"></span></span><br />
				<span><strong>End time</strong><span id="end-time"></span></span>
			</div>
			<div id="total_report" style="width: 1000px; height: 500px; border: 1px #ddd solid; margin-top: 30px;"></div>
			<!--<div id="average_report" style="width: 1000px; height: 500px;"></div>-->
  	</div>
		<script src="https://code.jquery.com/jquery-3.1.0.js"></script>
		<script src="http://code.highcharts.com/highcharts.js"></script>
		<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
		
		<script type="text/javascript">

			$(document).ready(function(){
			var oids = {};
			Highcharts.setOptions({ global: { useUTC: false } });   
			function initObject() {
				$.ajax({url: '/obj', success: function(data) {
					oids = data;
					for (var i in data) {
						var val = data[i];
						oids[val.oid] = val;
						$('#uuids').append('<option value="' + val.oid + '">' + val.oid + '</options>');
					}
					getTotalData();
				}});
			}
			
			function addChart(id, title, series) {
				var chart = Highcharts.chart(id, {
					chart: {
							type: 'spline'
					},
					credits: {
						enabled: false
					},
					title: {
							text: title
					},
					xAxis:{  
						title: {  
								text: 'Time',  
								style: {  
										color: '#4572A7'  
								}  
						},  
						type: 'datetime'
          },  
					yAxis: {
							title: {
									text: ''
							}
					},
					legend: {
							layout: 'vertical',
							align: 'right',
							verticalAlign: 'middle'
					},
					plotOptions: {
							series: {
								animation: false,
									pointStart: 2010
							}
					},
					series: series
				});
			}

			function getTotalData() {
				var oid = $('#uuids').val();
				var uuidRecord = oids[oid];
				var db = $('#db').val();
				var support = $('#support').val();
				var da = getTime();
				var url = '/report?db=' + db + '&uuid=' + uuidRecord.uuid + '&oid=' + uuidRecord.oid;
				if (support) {
					url += '&' + support + '=true';
				}
				url += '&start-time=' + Math.round(da[0] / 1000);
				url += '&end-time=' + Math.round(da[1] / 1000);
				$.ajax({url: url,
					success: function(data) {
						var seriesData = {
						};
						
						var names = {};
						for (var j in data.keyValue) {
							names[data.keyValue[j]] = j;
						}

						for (var i in data.values) {
							var item = data.values[i];
							var timestamp = item['timestamp'] * 1000;
							var records = item.data;
							for (var index in records) {
								var seriesd = seriesData[index];
								if (!seriesd) {
									seriesd = [];
								}
								seriesd.push([timestamp, records[index]]);
								seriesData[index] = seriesd;
							}
						}
						
						console.log(names);
						var series = [];
						for (var index in seriesData) {
							console.log(index, names[index]);
							series.push({name: names[index], data: seriesData[index]});
						}

						// var series = [
						// 	{
						// 		name: 'L7',
						// 		data: seriesData['ov_new_conn_l7']
						// 	},
						// 	{
						// 		name: 'L4',
						// 		data: seriesData['ov_new_conn_l4']
						// 	},
						// 	{
						// 		name: 'SSL',
						// 		data: seriesData['ov_new_conn_ssl']
						// 	},
						// 	{
						// 		name: 'IP NAT',
						// 		data: seriesData['ov_new_conn_ipnat']
						// 	},
						// 	{
						// 		name: 'Total',
						// 		data: seriesData['total_connection']
						// 	}
						// ];
						addChart('total_report', 'New connections', series);
					}
				});
			}

			function getTime() {
				var db = $('#db').val();
				var currentDate = new Date().getTime();
				var duration = 300;
				if (db === '30m') {
					duration = 30 * 60;
				} else if (db === '1h') {
					duration = 3600;
				} else if (db === '7h') {
					duration = 7 * 3600;
				} else if (db === '1d') {
					duration = 24 * 3600;
				} else if (db === '7d') {
					duration = 7 * 24 * 3600;
				} else if (db === '30d') {
					duration = 30 * 24 * 3600;
				}

				return [currentDate - duration * 1000, currentDate];

				
			}

			function changeDB() {
				var da = getTime();
				$('#end-time').html(new Date(da[1]));
				$('#start-time').html(new Date(da[0]));
		  }

			changeDB();
			$('#getMore').click(getTotalData);
			$('#db').change(changeDB);
			initObject();
			// getTotalData();
			// getAverageData();
			// setInterval(getData, 5000);
			});
		</script>
	</body>
</html>
